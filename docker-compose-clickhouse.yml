---
version: '3.7'

services:
  pmm-server-external-clickhouse:
    image: ${PMM_SERVER_IMAGE:-perconalab/pmm-server-fb:PR-3847-f05e17e}
    container_name: pmm-server-external-clickhouse
    depends_on:
      external-clickhouse:
        condition: service_healthy
    ports:
      - '8081:8080'
      - '8444:8443'
    environment:
      - PMM_DEBUG=1
      - PMM_DEV_PERCONA_PLATFORM_ADDRESS=check-dev.percona.com:443
      - PMM_DEV_PERCONA_PLATFORM_PUBLIC_KEY=RWTg+ZmCCjt7O8eWeAmTLAqW+1ozUbpRSKSwNTmO+exlS5KEIPYWuYdX
      - PMM_DEV_VERSION_SERVICE_URL=https://check-dev.percona.com/versions/v1
      - PMM_DEV_TELEMETRY_INTERVAL=10s
      - PMM_DEV_TELEMETRY_RETRY_BACKOFF=10s
      - PMM_CLICKHOUSE_ADDR=external-clickhouse:9000
      - PMM_CLICKHOUSE_DATASOURCE=external-clickhouse:8123
      - PMM_CLICKHOUSE_DATABASE=pmm
      - PMM_DISABLE_BUILTIN_CLICKHOUSE=1
      - PMM_ENABLE_TELEMETRY=0
      - PMM_CLICKHOUSE_PASSWORD=pmm_password
      - PMM_CLICKHOUSE_USER=pmm
      - PMM_CLICKHOUSE_DATABASE=pmm
      - PMM_CLICKHOUSE_ADDR=external-clickhouse:9000

  pmm-client:
    image: perconalab/pmm-client:3-dev-latest
    container_name: pmm-client-clickhouse
    depends_on:
      pmm-server-external-clickhouse:
        condition: service_healthy
    environment:
      - PMM_AGENT_SETUP=1
      - PMM_AGENT_SERVER_ADDRESS=pmm-server-external-clickhouse:8443
      - PMM_AGENT_SERVER_USERNAME=admin
      - PMM_AGENT_SERVER_PASSWORD=admin
      - PMM_AGENT_PORTS_MIN=41000
      - PMM_AGENT_PORTS_MAX=41500
      - PMM_AGENT_SERVER_INSECURE_TLS=1
      - PMM_AGENT_CONFIG_FILE=config/pmm-agent.yaml
      - PMM_AGENT_SETUP_NODE_NAME=pmm-client-clickhouse-container
      - PMM_AGENT_SETUP_FORCE=1
      - PMM_AGENT_SETUP_NODE_TYPE=container
    restart: on-failure

  ps8:
    container_name: ps8
    image: percona:8
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 7B*53@lCdflR

  external-clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: external-clickhouse
    environment:
      - CLICKHOUSE_DB=pmm
      - CLICKHOUSE_USER=pmm
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_PASSWORD=pmm_password
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'localhost:8123/ping']
